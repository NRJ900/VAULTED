"use strict";const a=require("electron"),E=require("node:child_process"),l=require("node:path"),c=require("node:fs"),I=require("node:crypto");class J{constructor(e){const s=a.app.getPath("userData");this.path=l.join(s,e);const o="game-vault-secure-storage-key-v1";this.encryptionKey=I.scryptSync(o,"salt",32)}get(e){try{if(!c.existsSync(this.path))return;const o=JSON.parse(c.readFileSync(this.path,"utf8"))[e];return o?typeof o=="string"&&o.startsWith("ENC:")?this.decrypt(o.substring(4)):o:void 0}catch(s){console.error("Error reading store:",s);return}}set(e,s,o=!1){try{let t={};c.existsSync(this.path)&&(t=JSON.parse(c.readFileSync(this.path,"utf8"))),o?t[e]="ENC:"+this.encrypt(s):t[e]=s,c.writeFileSync(this.path,JSON.stringify(t,null,2))}catch(t){console.error("Error writing to store:",t)}}encrypt(e){const s=I.randomBytes(16),o=I.createCipheriv("aes-256-cbc",this.encryptionKey,s);let t=o.update(JSON.stringify(e));return t=Buffer.concat([t,o.final()]),s.toString("hex")+":"+t.toString("hex")}decrypt(e){const s=e.split(":"),o=Buffer.from(s.shift(),"hex"),t=Buffer.from(s.join(":"),"hex"),f=I.createDecipheriv("aes-256-cbc",this.encryptionKey,o);let d=f.update(t);return d=Buffer.concat([d,f.final()]),JSON.parse(d.toString())}}const W=new J("data.json");a.ipcMain.handle("save-data",async(r,e,s,o=!1)=>(W.set(e,s,o),!0));a.ipcMain.handle("load-data",async(r,e)=>W.get(e));a.ipcMain.handle("select-game-exe",async()=>(await a.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Executables",extensions:["exe"]}]})).filePaths[0]);a.ipcMain.handle("select-folder",async()=>(await a.dialog.showOpenDialog({properties:["openDirectory"]})).filePaths[0]);a.ipcMain.handle("save-backup",async(r,e)=>{const s=await a.dialog.showSaveDialog({title:"Save Backup",defaultPath:"gamevault-backup.json",filters:[{name:"JSON",extensions:["json"]}]});return!s.canceled&&s.filePath?(c.writeFileSync(s.filePath,e),!0):!1});a.ipcMain.handle("load-backup",async()=>{const r=await a.dialog.showOpenDialog({title:"Load Backup",filters:[{name:"JSON",extensions:["json"]}],properties:["openFile"]});if(!r.canceled&&r.filePaths.length>0){const e=c.readFileSync(r.filePaths[0],"utf-8");return JSON.parse(e)}return null});a.ipcMain.handle("open-path",async(r,e)=>{a.shell.showItemInFolder(e)});a.ipcMain.handle("select-image",async()=>(await a.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Images",extensions:["jpg","png","webp","jpeg"]}]})).filePaths[0]);a.ipcMain.handle("launch-external",async(r,e)=>{try{return await a.shell.openExternal(e),!0}catch(s){return console.error("Failed to open external protocol:",s),!1}});a.ipcMain.handle("window-minimize",()=>{n==null||n.minimize()});a.ipcMain.handle("window-maximize",()=>{n!=null&&n.isMaximized()?n.unmaximize():n==null||n.maximize()});a.ipcMain.handle("window-close",()=>{n==null||n.close()});a.ipcMain.handle("launch-game",async(r,e)=>new Promise((s,o)=>{const t=l.basename(e.executablePath);console.log(`Preparing to launch ${t}...`),e.steamAppId?(console.log(`Launching Steam game: ${e.steamAppId}`),a.shell.openExternal(`steam://run/${e.steamAppId}`)):(console.log(`Launching executable: ${e.executablePath}`),E.spawn(e.executablePath,[],{detached:!0,stdio:"ignore",cwd:l.dirname(e.executablePath)}).unref()),s(!0);let f=0;const d=30,u=()=>{E.exec("tasklist /FO CSV /NH",(x,w)=>{x&&console.error("Tasklist error:",x);const g=w.toLowerCase(),v=t.toLowerCase();if(g.includes(`"${v}"`)){console.log(`Game process ${t} detected! Monitoring...`);const R=setInterval(()=>{E.exec("tasklist /FO CSV /NH",(M,_)=>{_.toLowerCase().includes(`"${v}"`)||(clearInterval(R),console.log(`Game process ${t} exited.`),n==null||n.webContents.send("game-exited"))})},2e3)}else f++,f<d?setTimeout(u,2e3):(console.log(`Timed out waiting for ${t} to start.`),n==null||n.webContents.send("game-exited"))})};setTimeout(u,2e3)}));a.ipcMain.handle("stop-game",async(r,e)=>{const s=l.basename(e);return console.log(`Stopping game: ${s}`),new Promise(o=>{E.exec(`taskkill /IM "${s}" /F`,(t,f,d)=>{var u;t?(console.error(`Failed to kill process ${s}:`,t),d.includes("Access is denied")||(u=t.message)!=null&&u.includes("Access is denied")?(console.log("Access denied. Retrying with Admin privileges..."),E.exec(`powershell Start-Process taskkill -ArgumentList '/IM "${s}" /F' -Verb RunAs`,x=>{x?(console.error("Failed to kill process as Admin:",x),o(!1)):(console.log(`Successfully triggered Admin kill for ${s}`),o(!0))})):o(!1)):(console.log(`Successfully killed ${s}`),o(!0))})})});const z=(r,e)=>new Promise(s=>{E.exec(`reg query "${r}" /v "${e}"`,(o,t)=>{if(o){s(null);return}const f=t.match(/REG_SZ\s+(.+)/);f&&f[1]?s(f[1].trim()):s(null)})});a.ipcMain.handle("check-app-installed",async(r,e)=>{const o={steam:["C:\\Program Files (x86)\\Steam\\steam.exe","C:\\Program Files\\Steam\\steam.exe"],epic:["C:\\Program Files (x86)\\Epic Games\\Launcher\\Portal\\Binaries\\Win32\\EpicGamesLauncher.exe","C:\\Program Files (x86)\\Epic Games\\Launcher\\Portal\\Binaries\\Win64\\EpicGamesLauncher.exe","C:\\Program Files\\Epic Games\\Launcher\\Portal\\Binaries\\Win32\\EpicGamesLauncher.exe","C:\\Program Files\\Epic Games\\Launcher\\Portal\\Binaries\\Win64\\EpicGamesLauncher.exe"],gog:["C:\\Program Files (x86)\\GOG Galaxy\\GalaxyClient.exe","C:\\Program Files\\GOG Galaxy\\GalaxyClient.exe"]}[e]||[];for(const t of o)if(c.existsSync(t))return!0;try{if(e==="steam"){const t=await z("HKCU\\Software\\Valve\\Steam","SteamExe");if(t&&c.existsSync(t))return!0}else if(e==="epic"){if(await z("HKLM\\SOFTWARE\\WOW6432Node\\Epic Games\\EpicGamesLauncher","AppDataPath"))return!0}else if(e==="gog"){const t=await z("HKLM\\SOFTWARE\\WOW6432Node\\GOG.com\\GalaxyClient","clientExecutable");if(t&&c.existsSync(t))return!0}}catch(t){console.error(`Registry check failed for ${e}:`,t)}return!1});const U=process.env.VITE_DEV_SERVER_URL;let n=null;a.ipcMain.handle("scan-games",async(r,e)=>{console.log("Starting smart game scan...",e?`Custom path: ${e}`:"Full scan");const s=[],t=await(async()=>new Promise(i=>{E.exec("wmic logicaldisk get name",(h,y)=>{if(h){i(["C:","D:","E:"]);return}const m=y.split(`
`).map(P=>P.trim()).filter(P=>/^[A-Z]:$/.test(P));i(m.length>0?m:["C:","D:","E:"])})}))();console.log("Detected drives:",t);const f=["unins","setup","update","crash","config","redist","framework","helper","sys","dx","vcredist","microsoft","windows","common files","internet explorer","reference assemblies","windows defender"],d=["steam_api.dll","steam_api64.dll","galaxy.dll","UnityPlayer.dll","fmod.dll","D3Dcompiler_47.dll","os_api.dll","bink2w64.dll"],u=i=>{try{return c.readdirSync(i).some(h=>d.includes(h))}catch{return!1}},x=i=>{const h=i.match(/"name"\s+"([^"]+)"/i),y=i.match(/"installdir"\s+"([^"]+)"/i),m=i.match(/"appid"\s+"(\d+)"/i);return h&&y?{name:h[1],installDir:y[1],appId:m?m[1]:void 0}:null},w=(i,h=0,y=3,m=!1)=>{if(c.existsSync(i)&&!(h>y))try{const P=c.readdirSync(i);for(const S of P){if(f.some(j=>S.toLowerCase().includes(j)))continue;const C=l.join(i,S);try{if(!c.statSync(C).isDirectory())continue;const D=u(C),b=c.readdirSync(C).filter($=>$.toLowerCase().endsWith(".exe")).filter($=>!f.some(O=>$.toLowerCase().includes(O)));let k=!1,A="";if(D)k=!0;else if(b.length>0){const $=b.find(O=>O.toLowerCase().includes(S.toLowerCase()));if($)A=$,k=!0;else if(!m){const N=b.sort((q,H)=>{try{return c.statSync(l.join(C,H)).size-c.statSync(l.join(C,q)).size}catch{return 0}})[0];c.statSync(l.join(C,N)).size>20*1024*1024&&(A=N,k=!0)}}if(k&&(!A&&b.length>0&&(A=b.find($=>$.toLowerCase().includes(S.toLowerCase()))||b[0]),A)){s.push({name:S,path:l.join(C,A)});continue}w(C,h+1,y,m)}catch{}}}catch{}};if(e){console.log(`Scanning custom path: ${e}`),w(e,0,5,!1);const i=s.filter((m,P,S)=>P===S.findIndex(C=>C.path===m.path)),h=[],y=new Set;for(const m of i)y.has(m.name)||(y.add(m.name),h.push(m));return console.log(`Custom scan complete. Found ${h.length} games.`),h}const g=["C:\\Program Files (x86)\\Steam","C:\\Program Files\\Steam"];for(const i of t)g.push(`${i}\\SteamLibrary`),g.push(`${i}\\Steam`);const v=["C:\\Program Files (x86)\\Steam","C:\\Program Files\\Steam",...t.map(i=>`${i}\\Steam`)];for(const i of v){const h=l.join(i,"steamapps","libraryfolders.vdf");if(c.existsSync(h))try{const m=c.readFileSync(h,"utf-8").match(/"path"\s+"([^"]+)"/g);m&&m.forEach(P=>{const S=P.split('"')[3].replace(/\\\\/g,"\\");g.includes(S)||g.push(S)})}catch(y){console.error("Error parsing libraryfolders.vdf:",y)}}for(const i of g){const h=l.join(i,"steamapps");if(c.existsSync(h))try{const y=c.readdirSync(h);for(const m of y)if(m.startsWith("appmanifest_")&&m.endsWith(".acf"))try{const P=c.readFileSync(l.join(h,m),"utf-8"),S=x(P);if(S){const C=l.join(h,"common",S.installDir);if(c.existsSync(C))try{const D=c.readdirSync(C).filter(G=>G.toLowerCase().endsWith(".exe"));let L="";if(L=D.find(G=>G.toLowerCase().includes(S.installDir.toLowerCase()))||"",L||(L=D.find(G=>["launcher.exe","game.exe","start.exe"].includes(G.toLowerCase()))||""),!L&&D.length>0){const G=D.map(b=>{try{return{name:b,size:c.statSync(l.join(C,b)).size}}catch{return{name:b,size:0}}});G.sort((b,k)=>k.size-b.size),L=G[0].name}L&&s.push({name:S.name,path:l.join(C,L),steamAppId:S.appId})}catch{}}}catch{}}catch{}}const F=["C:\\Games","C:\\Program Files\\Epic Games","C:\\Program Files (x86)\\Epic Games","C:\\Program Files\\GOG Galaxy\\Games","C:\\GOG Galaxy\\Games","C:\\Program Files (x86)\\Ubisoft\\Ubisoft Game Launcher\\games","C:\\Program Files\\Ubisoft\\Ubisoft Game Launcher\\games","C:\\XboxGames"];for(const i of t)i!=="C:"&&(F.push(`${i}\\Games`),F.push(`${i}\\Epic Games`),F.push(`${i}\\Program Files\\Epic Games`),F.push(`${i}\\GOG Galaxy\\Games`));for(const i of F)w(i,0,3,!0);const R=s.filter((i,h,y)=>h===y.findIndex(m=>m.path===i.path)),M=[],_=new Set;for(const i of R)_.has(i.name)||(_.add(i.name),M.push(i));return console.log(`Scan complete. Found ${M.length} games.`),M});a.ipcMain.handle("get-game-screenshots",async(r,e)=>{try{const s=l.join(a.app.getPath("userData"),"screenshots",e);return c.existsSync(s)?c.readdirSync(s).filter(t=>t.endsWith(".png")).map(t=>`media://${e}/${t}`):[]}catch(s){return console.error("Failed to get screenshots:",s),[]}});a.ipcMain.handle("open-screenshots-folder",async(r,e)=>{const s=l.join(a.app.getPath("userData"),"screenshots",e);c.existsSync(s)||c.mkdirSync(s,{recursive:!0}),await a.shell.openPath(s)});a.protocol.registerSchemesAsPrivileged([{scheme:"media",privileges:{secure:!0,standard:!0,supportFetchAPI:!0,corsEnabled:!0}}]);a.app.whenReady().then(()=>{a.protocol.registerFileProtocol("media",(r,e)=>{const s=r.url.replace("media://","");try{const o=decodeURIComponent(s);if(o.includes("..")){e({path:""});return}const t=l.join(a.app.getPath("userData"),"screenshots",o);e({path:t})}catch(o){console.error("Failed to handle media protocol:",o),e({path:""})}}),V(),Q()});const K=l.join(process.cwd(),"debug_log.txt"),p=r=>{try{c.appendFileSync(K,`[${new Date().toISOString()}] ${r}
`)}catch(e){console.error("Failed to write to log file:",e)}},Z=async(r,e)=>{p(`Attempting to take screenshot for ${r} (Exe: ${e})...`);try{const s=a.screen.getPrimaryDisplay(),o=await a.desktopCapturer.getSources({types:["window","screen"],thumbnailSize:s.size,fetchWindowIcons:!1});let t=null;const f=e?l.basename(e,l.extname(e)).toLowerCase():"";if(t||(t=o.find(d=>d.name.toLowerCase()===r.toLowerCase()),t&&p(`Found window matching game title: ${t.name}`)),!t&&f&&(t=o.find(d=>d.name.toLowerCase().includes(f)),t&&p(`Found window matching executable name: ${t.name}`)),t||(t=o.find(d=>d.name.toLowerCase().includes(r.toLowerCase())),t&&p(`Found window fuzzy matching game title: ${t.name}`)),t||(p("No matching window found. Falling back to primary display."),t=o.find(d=>d.display_id===s.id.toString())||o.find(d=>d.name==="Entire Screen")||o[0]),t){const d=t.thumbnail,u=l.join(a.app.getPath("userData"),"screenshots",r);c.existsSync(u)||c.mkdirSync(u,{recursive:!0});const w=`screenshot-${new Date().toISOString().replace(/[:.]/g,"-")}.png`,g=l.join(u,w);c.writeFileSync(g,d.toPNG()),p(`Screenshot saved to: ${g}`),n==null||n.webContents.send("screenshot-captured",{path:g,gameName:r})}else p("No source found for screenshot.")}catch(s){p(`Failed to take screenshot: ${s}`),console.error("Failed to take screenshot:",s)}},B=(r,e)=>{p(`Attempting to register screenshot shortcut for ${r}`);const s=["F12","CommandOrControl+F12","F9"];let o=!1;for(const t of s)try{if(a.globalShortcut.isRegistered(t)&&(p(`${t} is already registered. Unregistering first...`),a.globalShortcut.unregister(t)),a.globalShortcut.register(t,()=>{p(`${t} pressed - Taking screenshot...`),Z(r,e)})){p(`Screenshot shortcut (${t}) registered successfully.`),n==null||n.webContents.send("shortcut-registered",t),o=!0;break}else p(`Failed to register ${t}.`)}catch(f){p(`Error registering ${t}: ${f}`)}o||(p("All shortcut registration attempts failed."),n==null||n.webContents.send("shortcut-registration-failed"))},X=()=>{["F12","CommandOrControl+F12","F9"].forEach(e=>{a.globalShortcut.isRegistered(e)&&(a.globalShortcut.unregister(e),p(`Screenshot shortcut (${e}) unregistered`))})};let T=null;const Q=()=>{if(T)return;console.log("Starting global game monitoring..."),p("Starting global game monitoring...");const r=new Set;let e=null;T=setInterval(async()=>{const s=W.get("games");!s||!Array.isArray(s)||s.length===0||E.exec("tasklist /FO CSV /NH",(o,t)=>{if(o){p(`Tasklist error: ${o.message}`);return}const f=t.toLowerCase(),d=new Set;for(const u of s)if(u.executablePath){const x=l.basename(u.executablePath).toLowerCase(),w=u.executablePath.toLowerCase();f.includes(`"${x}"`)&&(d.add(w),r.has(w)||(p(`MATCH FOUND! ${x} started.`),r.add(w),n==null||n.webContents.send("game-detected",u),e=u.title,B(u.title,u.executablePath)))}for(const u of r)if(!d.has(u)){p(`Game exited: ${l.basename(u)}`),r.delete(u);const x=s.find(w=>{var g;return((g=w.executablePath)==null?void 0:g.toLowerCase())===u});if(x&&(n==null||n.webContents.send("game-exited",x),e===x.title&&(X(),e=null,r.size>0))){const w=Array.from(r)[0],g=s.find(v=>{var F;return((F=v.executablePath)==null?void 0:F.toLowerCase())===w});g&&(e=g.title,B(g.title,g.executablePath))}}})},5e3)};function V(){const r=l.join(__dirname,"preload.js");if(console.log("Preload path:",r),n=new a.BrowserWindow({width:1280,height:800,minWidth:1024,minHeight:600,icon:l.join(process.env.VITE_PUBLIC||l.join(__dirname,"../src/public"),"VAULTED.ico"),webPreferences:{preload:r,nodeIntegration:!0,contextIsolation:!0,webSecurity:!1},frame:!1,titleBarStyle:"hidden",title:"VAULTED Game Launcher",backgroundColor:"#000000"}),n.webContents.on("before-input-event",(e,s)=>{s.control&&s.shift&&s.key.toLowerCase()==="i"&&(e.preventDefault(),console.log("Blocked DevTools shortcut")),s.key==="F12"&&(e.preventDefault(),console.log("Blocked F12 shortcut"))}),n.webContents.on("did-finish-load",()=>{if(n==null||n.webContents.send("main-process-message",new Date().toLocaleString()),a.app.isPackaged){const{autoUpdater:e}=require("electron-updater");e.checkForUpdatesAndNotify(),e.on("update-available",()=>{n==null||n.webContents.send("update-available")}),e.on("update-downloaded",()=>{n==null||n.webContents.send("update-downloaded")})}}),U)n.loadURL(U);else{const e="dist/index.html";console.log("Loading production index from (relative):",e),n.loadFile(e)}}a.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(a.app.quit(),n=null)});a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&V()});
